<!DOCTYPE html>
<html>

<head>
    <title>Flappy Bird</title>
    <style>
        body {
            background: #000;
            margin: 0;
            overflow: hidden;
            font-family: 'Outfit', sans-serif;
        }

        canvas {
            display: block;
        }

        .ui {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #ffeb3b;
            font-size: 32px;
            z-index: 10;
            pointer-events: none;
            text-shadow: 2px 2px #000;
        }
    </style>
</head>

<body>
    <div class="ui">Score: <span id="score">0</span></div>
    <canvas id="game"></canvas>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score');

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        const flappyImg = new Image();
        flappyImg.src = '/static/games/assets/flappy_hero.png';

        function playSound(freq, type = 'sine', duration = 0.1) {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start();
                osc.stop(audioCtx.currentTime + duration);
            } catch (e) { }
        }

        let score = 0;
        let bird = { x: 100, y: 200, w: 45, h: 45, velocity: 0, gravity: 0.6, jump: -9 };
        let pipes = [];
        let frame = 0;
        let gameActive = true;

        resize();
        window.addEventListener('resize', resize);

        window.onkeydown = e => { if (e.code === 'Space') jump(); };
        canvas.onclick = jump;

        function jump() {
            if (!gameActive) return;
            bird.velocity = bird.jump;
            playSound(400, 'triangle');
        }

        function createPipe() {
            if (frame % 100 === 0) {
                let gap = 180;
                let minHeight = 100;
                let maxHeight = canvas.height - gap - minHeight;
                let height = Math.floor(Math.random() * (maxHeight - minHeight + 1) + minHeight);
                pipes.push({ x: canvas.width, y: 0, w: 70, h: height, type: 'top' });
                pipes.push({ x: canvas.width, y: height + gap, w: 70, h: canvas.height - height - gap, type: 'bottom' });
            }
        }

        function update() {
            if (!gameActive) return;

            bird.velocity += bird.gravity;
            bird.y += bird.velocity;

            if (bird.y + bird.h > canvas.height || bird.y < 0) {
                gameOver();
            }

            pipes.forEach((p, i) => {
                p.x -= 4;
                if (p.x + p.w < 0) {
                    pipes.splice(i, 1);
                    if (p.type === 'top') {
                        score++;
                        scoreEl.innerText = score;
                    }
                }

                const padding = 5;
                if (bird.x + padding < p.x + p.w && bird.x + bird.w - padding > p.x && bird.y + padding < p.y + p.h && bird.y + bird.h - padding > p.y) {
                    gameOver();
                }
            });

            createPipe();
            frame++;
        }

        function gameOver() {
            gameActive = false;
            playSound(150, 'sawtooth', 0.4);
            alert('Game Over! Score: ' + score);
            location.reload();
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Bird
            if (flappyImg.complete) {
                ctx.save();
                ctx.translate(bird.x + bird.w / 2, bird.y + bird.h / 2);
                ctx.rotate(bird.velocity * 0.04);
                ctx.drawImage(flappyImg, -bird.w / 2, -bird.h / 2, bird.w, bird.h);
                ctx.restore();
            } else {
                ctx.fillStyle = '#ffeb3b';
                ctx.fillRect(bird.x, bird.y, bird.w, bird.h);
            }

            // Pipes
            ctx.fillStyle = '#4caf50';
            pipes.forEach(p => {
                ctx.fillRect(p.x, p.y, p.w, p.h);
                ctx.lineWidth = 2;
                ctx.strokeStyle = '#2e7d32';
                ctx.strokeRect(p.x, p.y, p.w, p.h);
            });

            update();
            requestAnimationFrame(draw);
        }

        draw();
    </script>
</body>

</html>